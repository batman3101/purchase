<script>
// --- ì „ì—­ ë³€ìˆ˜ ë° ìƒìˆ˜ ---
// Code.gsì˜ SHEET_NAMES ê°ì²´ì™€ ë™ì¼í•˜ê²Œ ìœ ì§€
const SHEET_NAMES = {
  HISTORY: "PurchaseHistory",
  PO: "PO_List",
  STATEMENTS: "Statements",
  SUPPLIERS: "Suppliers",
  TAX: "TaxInvoices",
  DB: "ItemDatabase"
};

// íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨ ìƒìˆ˜
const FILE_UPLOAD_CONFIG = {
  MAX_SIZE_MB: 10,
  MAX_SIZE_BYTES: 10 * 1024 * 1024,  // 10MB in bytes
  ALLOWED_TYPES: [
    'application/pdf',
    'image/jpeg',
    'image/jpg',
    'image/png',
    'image/gif',
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/vnd.ms-excel',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
  ]
};

// PO/Item ëª¨ë‹¬ì—ì„œ ì‚¬ìš©í•  ì•„ì´í…œ ë°ì´í„° ìºì‹œ
let poModalItemsData = [];
let supplierMapData = {};


/**
 * ì•±ì´ ì²˜ìŒ ë¡œë“œë  ë•Œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.
 */
document.addEventListener("DOMContentLoaded", function() {
    // 1. ê¸°ë³¸ í˜ì´ì§€(ëŒ€ì‹œë³´ë“œ) ë¡œë“œ
    loadPage("ëŒ€ì‹œë³´ë“œ", document.querySelector(".nav-link.active"));

    // 2. ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelectorAll(".sidebar-nav .nav-link").forEach(link => {
        link.addEventListener("click", function(e) {
            e.preventDefault(); // ê¸°ë³¸ ì•µì»¤ ë™ì‘(#) ë°©ì§€
            
            if (this.classList.contains("active")) {
                return;
            }

            const pageTitle = this.dataset.page;
            loadPage(pageTitle, this);
            
            if (window.innerWidth < 768) {
                document.querySelector(".grid-container").classList.remove("sidebar-open");
            }
        });
    });

    // 3. ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ í† ê¸€ ë²„íŠ¼
    document.getElementById("mobile-nav-toggle").addEventListener("click", function() {
        document.querySelector(".grid-container").classList.toggle("sidebar-open");
    });

    // 4. ëª¨ë‹¬ ì°½ ë‹«ê¸° ì´ë²¤íŠ¸ (ì˜¤ë²„ë ˆì´ í´ë¦­ ì‹œ)
    const modalOverlay = document.getElementById("modal-overlay");
    modalOverlay.addEventListener("click", function(e) {
        if (e.target === modalOverlay) {
            closeModal();
        }
    });

    // 5. í¼ ì œì¶œ ì´ë²¤íŠ¸ ë°”ì¸ë”© (document ë ˆë²¨ ì´ë²¤íŠ¸ ìœ„ì„)
    // ëª¨ë“  submit ì´ë²¤íŠ¸ë¥¼ documentì—ì„œ ì²˜ë¦¬í•˜ì—¬ ë™ì ìœ¼ë¡œ ìƒì„±ëœ í¼ë„ ì²˜ë¦¬
    document.addEventListener("submit", function(e) {
        console.log("ğŸ“ Submit event detected!");
        console.log("Event target:", e.target);

        // ì²˜ë¦¬í•  í¼ ID í™•ì¸
        const formId = e.target.id;
        console.log("Form ID:", formId);

        // ìš°ë¦¬ê°€ ì²˜ë¦¬í•˜ëŠ” í¼ì¸ ê²½ìš°ì—ë§Œ ê¸°ë³¸ ë™ì‘ ë°©ì§€
        if (formId === 'purchase-form' ||
            formId === 'supplier-form' ||
            formId === 'po-form' ||
            formId === 'item-db-form' ||
            formId === 'upload-form-statement' ||
            formId === 'upload-form-tax') {

            console.log("âœ… Form recognized, preventing default...");
            e.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€

            // ê° í¼ì— ë§ëŠ” í•¸ë“¤ëŸ¬ í˜¸ì¶œ
            if (formId === 'purchase-form') {
                console.log("â†’ Calling handlePurchaseFormSubmit");
                handlePurchaseFormSubmit(e.target);
            } else if (formId === 'supplier-form') {
                console.log("â†’ Calling handleSupplierFormSubmit");
                handleSupplierFormSubmit(e.target);
            } else if (formId === 'po-form') {
                console.log("â†’ Calling handlePOFormSubmit");
                handlePOFormSubmit(e.target);
            } else if (formId === 'item-db-form') {
                console.log("â†’ Calling handleItemDBFormSubmit");
                handleItemDBFormSubmit(e.target);
            } else if (formId === 'upload-form-statement') {
                console.log("â†’ Calling handleFileUpload (STATEMENT)");
                handleFileUpload(e.target, 'STATEMENT');
            } else if (formId === 'upload-form-tax') {
                console.log("â†’ Calling handleFileUpload (TAX)");
                handleFileUpload(e.target, 'TAX');
            }
        } else {
            console.log("âš ï¸ Form ID not recognized:", formId);
        }
    });

    // 6. ê¸°íƒ€ ì´ë²¤íŠ¸ ë°”ì¸ë”© (ì´ë²¤íŠ¸ ìœ„ì„)
    const contentWrapper = document.getElementById("content-wrapper");
    contentWrapper.addEventListener("input", function(e) {
        // 'êµ¬ë§¤ ë“±ë¡' ì´ì•¡ ìë™ ê³„ì‚°
        if (e.target.id === 'reg-qty' || e.target.id === 'reg-price') {
            const qty = document.getElementById('reg-qty').value || 0;
            const price = document.getElementById('reg-price').value || 0;
            document.getElementById('reg-total').value = qty * price;
        }
        // 'êµ¬ë§¤ ë‚´ì—­' ê²€ìƒ‰ í•„í„°
        if (e.target.id === 'history-search') {
            filterTable(e.target);
        }
    });

    contentWrapper.addEventListener("click", function(e) {
        // 'ë¶„ì„' í˜ì´ì§€ íƒ­ í´ë¦­
        if (e.target.classList.contains('tab-link')) {
            handleTabClick(e.target);
        }
        // PO/Item ëª¨ë‹¬ì˜ ë™ì  í–‰ ì¶”ê°€/ì‚­ì œ
        if (e.target.classList.contains('add-po-item-row')) {
            addPOItemRow();
        }
        if (e.target.classList.contains('add-item-supplier-row')) {
            addItemSupplierRow();
        }
        if (e.target.classList.contains('remove-row-btn')) {
            e.target.closest('.dynamic-row').remove();
            // PO ëª¨ë‹¬ì¸ ê²½ìš° ì´ì•¡ ì—…ë°ì´íŠ¸
            if (e.target.closest('#po-form')) {
                updatePOTotal();
            }
        }
    });

    // PO ëª¨ë‹¬ì˜ ì•„ì´í…œ ê°€ê²©/í•©ê³„ ìë™ ê³„ì‚°
    contentWrapper.addEventListener('change', function(e) {
        if (e.target.classList.contains('po-item-name')) {
            onPOItemSelect(e.target);
        }
        if (e.target.classList.contains('po-item-qty') || e.target.classList.contains('po-item-price')) {
            updatePOTotal();
        }
    });
});


// --- ë¡œë”© ë° í˜ì´ì§€ ì „í™˜ ---

function loadPage(pageTitle, linkElement) {
    showSpinner();
    document.getElementById("page-title").textContent = pageTitle;

    document.querySelectorAll(".sidebar-nav .nav-link").forEach(link => {
        link.classList.remove("active");
    });
    if (linkElement) {
        linkElement.classList.add("active");
    }

    google.script.run
        .withSuccessHandler(html => {
            document.getElementById("content-wrapper").innerHTML = html;
            hideSpinner();
            // í˜ì´ì§€ ë¡œë“œ í›„ ì¶”ê°€ ì‘ì—…
            if(pageTitle === "êµ¬ë§¤ ë‚´ì—­") {
                bindHistorySearch(); // ê²€ìƒ‰ ì´ë²¤íŠ¸ ë°”ì¸ë”©
            }
        })
        .withFailureHandler(error => {
            document.getElementById("content-wrapper").innerHTML = `<p style="color:red;">í˜ì´ì§€ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</p>`;
            hideSpinner();
        })
        .getPage(pageTitle);
}

function showSpinner() {
    document.getElementById("spinner-overlay").style.display = "flex";
}

function hideSpinner() {
    document.getElementById("spinner-overlay").style.display = "none";
}

// --- ì»¤ìŠ¤í…€ ëª¨ë‹¬ (Alert/Confirm ëŒ€ì²´) ---

function showModal(title, contentHtml) {
    document.getElementById("modal-title").textContent = title;
    document.getElementById("modal-content").innerHTML = contentHtml;
    document.getElementById("modal-overlay").style.display = "flex";
}

function closeModal() {
    document.getElementById("modal-overlay").style.display = "none";
    document.getElementById("modal-content").innerHTML = ""; // ë‚´ìš© ë¹„ìš°ê¸°
}

function showConfirm(message, onOk) {
    const confirmOverlay = document.getElementById("confirm-overlay");
    document.getElementById("confirm-message").textContent = message;
    confirmOverlay.style.display = "flex";

    const okButton = document.getElementById("confirm-ok");
    const cancelButton = document.getElementById("confirm-cancel");

    const newOkButton = okButton.cloneNode(true);
    okButton.parentNode.replaceChild(newOkButton, okButton);

    const newCancelButton = cancelButton.cloneNode(true);
    cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);

    newOkButton.addEventListener("click", () => {
        confirmOverlay.style.display = "none";
        onOk();
    });
    newCancelButton.addEventListener("click", () => {
        confirmOverlay.style.display = "none";
    });
}

function showAlert(message, isError = false) {
    const title = isError ? "ì˜¤ë¥˜" : "ì•Œë¦¼";
    const content = `<p class="${isError ? 'text-danger' : ''}">${message}</p>`;
    showModal(title, content);
}

// --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

/**
 * HTML íŠ¹ìˆ˜ë¬¸ìë¥¼ ì´ìŠ¤ì¼€ì´í”„í•˜ì—¬ XSS ê³µê²©ì„ ë°©ì§€í•©ë‹ˆë‹¤.
 * @param {string} text ì´ìŠ¤ì¼€ì´í”„í•  í…ìŠ¤íŠ¸
 * @returns {string} ì´ìŠ¤ì¼€ì´í”„ëœ í…ìŠ¤íŠ¸
 */
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatVND(number) {
    return new Intl.NumberFormat('en-US').format(number);
}

// --- 'êµ¬ë§¤ ë‚´ì—­' í˜ì´ì§€ (ê²€ìƒ‰) ---
function bindHistorySearch() {
    const searchInput = document.querySelector('.card input[type="search"]');
    if (searchInput) {
        // IDë¥¼ ë™ì ìœ¼ë¡œ í• ë‹¹ (Code.gsì—ì„œ IDê°€ ì—†ìœ¼ë¯€ë¡œ)
        searchInput.id = 'history-search';
    }
}

function filterTable(input) {
    const filter = input.value.toUpperCase();
    const table = document.querySelector(".styled-table");
    const tr = table.getElementsByTagName("tr");

    // Loop through all table rows, and hide those who don't match the search query
    // (index 0ì€ a_theadì´ë¯€ë¡œ 1ë¶€í„° ì‹œì‘)
    for (let i = 1; i < tr.length; i++) {
        const tdArray = tr[i].getElementsByTagName("td");
        let textValue = "";
        for (let j = 0; j < tdArray.length; j++) {
            if (tdArray[j]) {
                textValue += tdArray[j].textContent || tdArray[j].innerText;
            }
        }
        
        if (textValue.toUpperCase().indexOf(filter) > -1) {
            tr[i].style.display = "";
        } else {
            tr[i].style.display = "none";
        }
    }
}

// --- 'êµ¬ë§¤ ë“±ë¡' í˜ì´ì§€ ---

function handlePOSelection(poId) {
    if (!poId || poId.trim() === '') {
        // PO ì„ íƒ í•´ì œ ì‹œ í¼ ì´ˆê¸°í™”
        document.getElementById('reg-item').value = '';
        document.getElementById('reg-category').value = '';
        document.getElementById('reg-supplier').value = '';
        document.getElementById('reg-qty').value = '1';
        document.getElementById('reg-unit').value = '';
        document.getElementById('reg-price').value = '';
        document.getElementById('reg-total').value = '';
        return;
    }

    showSpinner();
    google.script.run
        .withSuccessHandler(poDetails => {
            hideSpinner();

            // POì˜ ì²« ë²ˆì§¸ ì•„ì´í…œ ì •ë³´ë¡œ í¼ ìë™ì…ë ¥
            if (poDetails.items && poDetails.items.length > 0) {
                const firstItem = poDetails.items[0];
                document.getElementById('reg-item').value = firstItem.name || '';
                document.getElementById('reg-category').value = firstItem.category || '';
                document.getElementById('reg-qty').value = firstItem.quantity || '1';
                document.getElementById('reg-unit').value = firstItem.unit || '';
                document.getElementById('reg-price').value = firstItem.unitPrice || '0';

                // ì´ì•¡ ìë™ ê³„ì‚°
                const qty = Number(firstItem.quantity) || 0;
                const price = Number(firstItem.unitPrice) || 0;
                document.getElementById('reg-total').value = qty * price;

                // ê³µê¸‰ì‚¬ ìë™ ì„ íƒ
                document.getElementById('reg-supplier').value = poDetails.supplierId || '';

                showAlert(`PO ${poId}ì˜ ì²« ë²ˆì§¸ ì•„ì´í…œ ì •ë³´ê°€ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } else {
                showAlert('ì´ POì—ëŠ” ì•„ì´í…œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.', true);
            }
        })
        .withFailureHandler(error => {
            hideSpinner();
            showAlert(error.message, true);
        })
        .getPODetails(poId);
}

function handlePurchaseFormSubmit(form) {
    showSpinner();
    const formData = {
        poId: form.poId.value,
        itemName: form.itemName.value,
        category: form.category.value,
        supplierId: form.supplierId.value,
        purchaseDate: form.purchaseDate.value,
        quantity: form.quantity.value,
        unit: form.unit.value,
        unitPrice: form.unitPrice.value
    };

    const messageDiv = document.getElementById("form-message");

    google.script.run
        .withSuccessHandler(response => {
            hideSpinner();
            messageDiv.textContent = response;
            messageDiv.className = "mt-1 text-success";
            form.reset(); 
            setTimeout(() => {
                loadPage("êµ¬ë§¤ ë‚´ì—­", document.querySelector('a[data-page="êµ¬ë§¤ ë‚´ì—­"]'));
            }, 3000);
        })
        .withFailureHandler(error => {
            hideSpinner();
            messageDiv.textContent = error.message;
            messageDiv.className = "mt-1 text-danger";
        })
        .addPurchaseEntry(formData);
}

// --- 'ê³µê¸‰ì‚¬ ê´€ë¦¬' í˜ì´ì§€ (CRUD) ---

function showAddSupplierModal() {
    const content = `
        <form id="supplier-form">
            <input type="hidden" name="id" value="">
            <div class="form-group">
                <label for="sup-name">ê³µê¸‰ì‚¬ëª…</label>
                <input type="text" id="sup-name" name="name" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="sup-contact">ë‹´ë‹¹ìëª…</label>
                <input type="text" id="sup-contact" name="contactPerson" class="form-control">
            </div>
            <div class="form-group">
                <label for="sup-phone">ì—°ë½ì²˜</label>
                <input type="tel" id="sup-phone" name="phone" class="form-control">
            </div>
            <div class="form-group">
                <label for="sup-email">ì´ë©”ì¼</label>
                <input type="email" id="sup-email" name="email" class="form-control">
            </div>
            <div class="form-group">
                <label for="sup-address">ì£¼ì†Œ (ì„ íƒ)</label>
                <input type="text" id="sup-address" name="address" class="form-control">
            </div>
            <footer class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ì €ì¥</button>
            </footer>
        </form>
    `;
    showModal("ì‹ ê·œ ê³µê¸‰ì‚¬ ì¶”ê°€", content);

    // ëª¨ë‹¬ì´ í‘œì‹œëœ ì§í›„, í¼ì— ì§ì ‘ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    setTimeout(() => {
        const form = document.getElementById('supplier-form');
        console.log("ğŸ” í¼ ê²€ìƒ‰ ê²°ê³¼:", form);
        if (form) {
            console.log("âœ… í¼ ë°œê²¬! ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ ì¤‘...");
            form.addEventListener('submit', function(e) {
                console.log("ğŸ¯ ì§ì ‘ ë°”ì¸ë”©ëœ submit ì´ë²¤íŠ¸ ë°œìƒ!");
                e.preventDefault();
                handleSupplierFormSubmit(form);
            });
        } else {
            console.error("âŒ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
        }
    }, 100); // 100ms í›„ì— í¼ í™•ì¸
}

function editSupplier(id) {
    showSpinner();
    google.script.run
        .withSuccessHandler(supplier => {
            hideSpinner();
            const content = `
                <form id="supplier-form">
                    <input type="hidden" name="id" value="${supplier.id}">
                    <div class="form-group">
                        <label for="sup-name">ê³µê¸‰ì‚¬ëª…</label>
                        <input type="text" id="sup-name" name="name" class="form-control" value="${supplier.name || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="sup-contact">ë‹´ë‹¹ìëª…</label>
                        <input type="text" id="sup-contact" name="contactPerson" class="form-control" value="${supplier.contactPerson || ''}">
                    </div>
                    <div class="form-group">
                        <label for="sup-phone">ì—°ë½ì²˜</label>
                        <input type="tel" id="sup-phone" name="phone" class="form-control" value="${supplier.phone || ''}">
                    </div>
                    <div class="form-group">
                        <label for="sup-email">ì´ë©”ì¼</label>
                        <input type="email" id="sup-email" name="email" class="form-control" value="${supplier.email || ''}">
                    </div>
                    <div class="form-group">
                        <label for="sup-address">ì£¼ì†Œ (ì„ íƒ)</label>
                        <input type="text" id="sup-address" name="address" class="form-control" value="${supplier.address || ''}">
                    </div>
                    <footer class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-primary">ìˆ˜ì •</button>
                    </footer>
                </form>
            `;
            showModal("ê³µê¸‰ì‚¬ ì •ë³´ ìˆ˜ì •", content);
        })
        .withFailureHandler(error => {
            hideSpinner();
            showAlert(error.message, true);
        })
        .getSupplierDetails(id);
}

function deleteSupplier(id) {
    showConfirm(`ì •ë§ ì´ ê³µê¸‰ì‚¬(ID: ${id})ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
        showSpinner();
        google.script.run
            .withSuccessHandler(response => {
                hideSpinner();
                showAlert(response);
                loadPage("ê³µê¸‰ì‚¬ ê´€ë¦¬", document.querySelector('a[data-page="ê³µê¸‰ì‚¬ ê´€ë¦¬"]'));
            })
            .withFailureHandler(error => {
                hideSpinner();
                showAlert(error.message, true);
            })
            .deleteRowById(SHEET_NAMES.SUPPLIERS, id);
    });
}

/**
 * [ìˆ˜ì •ë¨] 'ì‹ ê·œ ê³µê¸‰ì‚¬ ì¶”ê°€' ë˜ëŠ” 'ìˆ˜ì •' í¼ ì œì¶œì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 * (ì¹˜ëª…ì ì¸ ëŸ°íƒ€ì„ ì˜¤ë¥˜ ìˆ˜ì •)
 */
function handleSupplierFormSubmit(form) {
    console.log("=== handleSupplierFormSubmit í˜¸ì¶œë¨ ===");
    console.log("Form:", form);

    showSpinner();
    const formData = {
        id: form.id.value,
        name: form.name.value,
        contactPerson: form.contactPerson.value,
        email: form.email.value,
        phone: form.phone.value,
        address: form.address.value
    };

    console.log("FormData:", formData);
    const isUpdate = formData.id ? true : false;
    console.log("isUpdate:", isUpdate);

    // ì„±ê³µ/ì‹¤íŒ¨ ì½œë°±ì„ ì •ì˜í•©ë‹ˆë‹¤.
    const successCallback = (response) => {
        console.log("âœ… Success:", response);
        hideSpinner();
        closeModal();
        showAlert(response);
        loadPage("ê³µê¸‰ì‚¬ ê´€ë¦¬", document.querySelector('a[data-page="ê³µê¸‰ì‚¬ ê´€ë¦¬"]'));
    };

    const failureCallback = (error) => {
        console.error("âŒ Error:", error);
        hideSpinner();
        showAlert(error.message, true);
    };

    // isUpdate ê°’ì— ë”°ë¼ ì˜¬ë°”ë¥¸ ì„œë²„ í•¨ìˆ˜ë¥¼ ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.
    if (isUpdate) {
        console.log("Calling updateSupplier...");
        google.script.run
            .withSuccessHandler(successCallback)
            .withFailureHandler(failureCallback)
            .updateSupplier(formData);
    } else {
        console.log("Calling addSupplier...");
        google.script.run
            .withSuccessHandler(successCallback)
            .withFailureHandler(failureCallback)
            .addSupplier(formData);
    }
}


// --- 'PO ê´€ë¦¬' í˜ì´ì§€ ---

function deletePO(id) {
    showConfirm(`ì •ë§ ì´ PO(ID: ${id})ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
        showSpinner();
        google.script.run
            .withSuccessHandler(response => {
                hideSpinner();
                showAlert(response);
                loadPage("PO ê´€ë¦¬", document.querySelector('a[data-page="PO ê´€ë¦¬"]'));
            })
            .withFailureHandler(error => {
                hideSpinner();
                showAlert(error.message, true);
            })
            .deleteRowById(SHEET_NAMES.PO, id);
    });
}

function cancelPO(id) {
    showConfirm(`PO(ID: ${id})ë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
        showSpinner();
        google.script.run
            .withSuccessHandler(response => {
                hideSpinner();
                showAlert(response);
                loadPage("PO ê´€ë¦¬", document.querySelector('a[data-page="PO ê´€ë¦¬"]'));
            })
            .withFailureHandler(error => {
                hideSpinner();
                showAlert(error.message, true);
            })
            .updatePOStatus(id, 'ì·¨ì†Œ');
    });
}

/**
 * 'ì•„ì´í…œ ë³´ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ POì˜ ì•„ì´í…œ ëª©ë¡ì„ ëª¨ë‹¬ë¡œ ë„ì›ë‹ˆë‹¤.
 */
function viewPOItems(id) {
    showSpinner();
    google.script.run
        .withSuccessHandler(html => {
            hideSpinner();
            showModal(`PO (${id}) ì•„ì´í…œ ëª©ë¡`, html);
        })
        .withFailureHandler(error => {
            hideSpinner();
            showAlert(error.message, true);
        })
        .getPOItemsAsHtml(id);
}

/**
 * 'ìƒˆ PO ìƒì„±' ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.
 */
function showAddPOModal() {
    showSpinner();
    // ì„œë²„ì—ì„œ ê³µê¸‰ì‚¬ ëª©ë¡, ì•„ì´í…œ ëª©ë¡ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
    google.script.run
        .withSuccessHandler(data => {
            hideSpinner();
            poModalItemsData = data.items; // ì•„ì´í…œ ë°ì´í„° ìºì‹œ
            
            let supplierOptions = data.suppliers.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            let itemDatalist = data.items.map(i => `<option value="${i.name}"></option>`).join('');

            const content = `
                <form id="po-form">
                    <div class="form-group">
                        <label for="po-supplier">ê³µê¸‰ì‚¬</label>
                        <select id="po-supplier" name="supplierId" class="form-control" required>
                            <option value="">-- ê³µê¸‰ì‚¬ ì„ íƒ --</option>
                            ${supplierOptions}
                        </select>
                    </div>

                    <hr class="mb-2">
                    <h5 style="margin-bottom: 10px;">ì•„ì´í…œ ëª©ë¡</h5>

                    <!-- ì•„ì´í…œ ê²€ìƒ‰ ê¸°ëŠ¥ -->
                    <div class="form-group" style="position: relative;">
                        <label for="po-item-search">ğŸ” ì•„ì´í…œ ê²€ìƒ‰ (ê¸°ì¡´ ì•„ì´í…œ ì„ íƒ)</label>
                        <input type="text" id="po-item-search" class="form-control" placeholder="ì•„ì´í…œëª…, ì¹´í…Œê³ ë¦¬ë¡œ ê²€ìƒ‰..." autocomplete="off">
                        <div id="po-search-results" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 250px; overflow-y: auto; width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                    </div>

                    <!-- ì»¬ëŸ¼ í—¤ë” -->
                    <div class="po-item-header" style="display: grid; grid-template-columns: 2fr 1.2fr 0.8fr 0.8fr 1.2fr 40px; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-weight: 600; font-size: 0.9em; color: #495057;">
                        <div>ì•„ì´í…œëª…</div>
                        <div>ì¹´í…Œê³ ë¦¬</div>
                        <div>ìˆ˜ëŸ‰</div>
                        <div>ë‹¨ìœ„</div>
                        <div>ë‹¨ê°€ (VND)</div>
                        <div></div>
                    </div>

                    <div id="po-item-list">
                        <!-- ë™ì  ì•„ì´í…œ í–‰ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm add-po-item-row mt-1">
                        + ì•„ì´í…œ ì¶”ê°€
                    </button>
                    <datalist id="item-list-datalist">
                        ${itemDatalist}
                    </datalist>

                    <hr class="mt-2 mb-2">
                    <div class="form-group">
                        <label for="po-notes">ë©”ëª¨ (ì„ íƒ)</label>
                        <textarea id="po-notes" name="notes" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="po-total-display">
                        <strong>ì´ í•©ê³„:</strong>
                        <span id="po-total-amount">0 VND</span>
                    </div>

                    <footer class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-primary">PO ìƒì„±</button>
                    </footer>
                </form>
            `;
            showModal("ìƒˆ PO ìƒì„±", content);
            addPOItemRow(); // ì²« ë²ˆì§¸ ì•„ì´í…œ í–‰ì„ ê¸°ë³¸ìœ¼ë¡œ ì¶”ê°€

            // ëª¨ë‹¬ì´ í‘œì‹œëœ ì§í›„, í¼ì— ì§ì ‘ ì´ë²¤íŠ¸ ë°”ì¸ë”© ë° ê²€ìƒ‰ ê¸°ëŠ¥ ì´ˆê¸°í™”
            setTimeout(() => {
                const form = document.getElementById('po-form');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        handlePOFormSubmit(form);
                    });
                }

                // ì•„ì´í…œ ê²€ìƒ‰ ê¸°ëŠ¥ ì´ˆê¸°í™”
                initializePOItemSearch();
            }, 100);
        })
        .withFailureHandler(error => {
            hideSpinner();
            showAlert(error.message, true);
        })
        .getPOModalData();
}

/**
 * PO ëª¨ë‹¬ì— ì•„ì´í…œ ì…ë ¥ í–‰ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
 */
function addPOItemRow() {
    const list = document.getElementById('po-item-list');
    const row = document.createElement('div');
    row.className = 'po-item-row dynamic-row';
    row.style.cssText = 'display: grid; grid-template-columns: 2fr 1.2fr 0.8fr 0.8fr 1.2fr 40px; gap: 8px; margin-bottom: 8px; align-items: center;';
    row.innerHTML = `
        <input type="text" name="itemName" class="form-control po-item-name" list="item-list-datalist" placeholder="ì•„ì´í…œëª… ì…ë ¥" required>
        <input type="text" name="category" class="form-control po-item-category" placeholder="ì¹´í…Œê³ ë¦¬" required>
        <input type="number" name="quantity" class="form-control po-item-qty" min="1" value="1" required>
        <input type="text" name="unit" class="form-control po-item-unit" placeholder="ea, kg ë“±" required>
        <input type="number" name="unitPrice" class="form-control po-item-price" min="0" value="0" required>
        <button type="button" class="btn-icon remove-row-btn" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
    `;
    list.appendChild(row);

    // ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ì´ì•¡ ì—…ë°ì´íŠ¸
    row.querySelectorAll('.po-item-qty, .po-item-price').forEach(input => {
        input.addEventListener('input', updatePOTotal);
    });

    // ì•„ì´í…œëª… ì„ íƒ ì‹œ ìë™ì™„ì„±
    row.querySelector('.po-item-name').addEventListener('change', function() {
        onPOItemSelect(this);
    });

    updatePOTotal();
}

/**
 * PO ëª¨ë‹¬ì— ì•„ì´í…œ ë°ì´í„°ê°€ ë¯¸ë¦¬ ì±„ì›Œì§„ í–‰ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
 */
function addPOItemRowWithData(itemData) {
    const list = document.getElementById('po-item-list');
    const row = document.createElement('div');
    row.className = 'po-item-row dynamic-row';
    row.style.cssText = 'display: grid; grid-template-columns: 2fr 1.2fr 0.8fr 0.8fr 1.2fr 40px; gap: 8px; margin-bottom: 8px; align-items: center;';
    row.innerHTML = `
        <input type="text" name="itemName" class="form-control po-item-name" list="item-list-datalist" value="${escapeAttribute(itemData.name)}" required readonly style="background: #f0f7ff;">
        <input type="text" name="category" class="form-control po-item-category" value="${escapeAttribute(itemData.category || '')}" required>
        <input type="number" name="quantity" class="form-control po-item-qty" min="1" value="1" required>
        <input type="text" name="unit" class="form-control po-item-unit" value="${escapeAttribute(itemData.defaultUnit || 'ea')}" required>
        <input type="number" name="unitPrice" class="form-control po-item-price" min="0" value="${itemData.defaultPrice || 0}" required>
        <button type="button" class="btn-icon remove-row-btn" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
    `;
    list.appendChild(row);

    // ì…ë ¥ í•„ë“œ ë³€ê²½ ì‹œ ì´ì•¡ ì—…ë°ì´íŠ¸
    row.querySelectorAll('.po-item-qty, .po-item-price').forEach(input => {
        input.addEventListener('input', updatePOTotal);
    });

    updatePOTotal();
}

/**
 * PO ëª¨ë‹¬ì—ì„œ ì•„ì´í…œì„ ì„ íƒ(datalist)í–ˆì„ ë•Œ ì¹´í…Œê³ ë¦¬/ë‹¨ê°€/ë‹¨ìœ„ë¥¼ ìë™ ì™„ì„±í•©ë‹ˆë‹¤.
 */
function onPOItemSelect(inputElement) {
    const selectedName = inputElement.value;
    const itemData = poModalItemsData.find(i => i.name === selectedName);
    if (itemData) {
        const row = inputElement.closest('.po-item-row');
        row.querySelector('.po-item-category').value = itemData.category || '';
        row.querySelector('.po-item-unit').value = itemData.defaultUnit || '';
        row.querySelector('.po-item-price').value = itemData.defaultPrice || 0;
        updatePOTotal();
    }
}

/**
 * PO ëª¨ë‹¬ì˜ ì•„ì´í…œ ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
 */
function initializePOItemSearch() {
    const searchInput = document.getElementById('po-item-search');
    const searchResults = document.getElementById('po-search-results');

    if (!searchInput || !searchResults) return;

    // ê²€ìƒ‰ ì…ë ¥ ì‹œ ê²°ê³¼ í‘œì‹œ
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim().toLowerCase();

        if (query.length === 0) {
            searchResults.style.display = 'none';
            searchResults.innerHTML = '';
            return;
        }

        // ì•„ì´í…œ ê²€ìƒ‰ (ì´ë¦„ ë˜ëŠ” ì¹´í…Œê³ ë¦¬ë¡œ)
        const filtered = poModalItemsData.filter(item => {
            const nameMatch = item.name.toLowerCase().includes(query);
            const categoryMatch = (item.category || '').toLowerCase().includes(query);
            return nameMatch || categoryMatch;
        });

        if (filtered.length === 0) {
            searchResults.innerHTML = '<div style="padding: 12px; color: #999; text-align: center;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            searchResults.style.display = 'block';
            return;
        }

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ (ìµœëŒ€ 10ê°œ)
        let html = '';
        filtered.slice(0, 10).forEach(item => {
            const priceText = item.defaultPrice ? `${Number(item.defaultPrice).toLocaleString('en-US')} VND` : 'ê°€ê²© ë¯¸ì •';
            html += `
                <div class="search-result-item" data-item-name="${escapeAttribute(item.name)}"
                     style="padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s;"
                     onmouseover="this.style.background='#f0f7ff'"
                     onmouseout="this.style.background='white'">
                    <div style="font-weight: 500; color: #2c3e50;">${escapeHtml(item.name)}</div>
                    <div style="font-size: 0.85em; color: #7f8c8d; margin-top: 2px;">
                        ì¹´í…Œê³ ë¦¬: ${escapeHtml(item.category || 'ë¯¸ë¶„ë¥˜')} |
                        ë‹¨ìœ„: ${escapeHtml(item.defaultUnit || 'ea')} |
                        ë‹¨ê°€: ${priceText}
                    </div>
                </div>
            `;
        });

        if (filtered.length > 10) {
            html += `<div style="padding: 8px 12px; background: #f8f9fa; text-align: center; color: #666; font-size: 0.85em;">ì™¸ ${filtered.length - 10}ê°œ ë”...</div>`;
        }

        searchResults.innerHTML = html;
        searchResults.style.display = 'block';

        // ê²€ìƒ‰ ê²°ê³¼ í´ë¦­ ì‹œ ì•„ì´í…œ ì¶”ê°€
        searchResults.querySelectorAll('.search-result-item').forEach(resultItem => {
            resultItem.addEventListener('click', function() {
                const itemName = this.getAttribute('data-item-name');
                const itemData = poModalItemsData.find(i => i.name === itemName);

                if (itemData) {
                    addPOItemRowWithData(itemData);
                    searchInput.value = '';
                    searchResults.style.display = 'none';
                    searchResults.innerHTML = '';
                    showAlert(`'${itemData.name}' ì•„ì´í…œì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                }
            });
        });
    });

    // ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ ê²°ê³¼ ìˆ¨ê¸°ê¸° (ì•½ê°„ì˜ ë”œë ˆì´ë¡œ í´ë¦­ ì´ë²¤íŠ¸ê°€ ë¨¼ì € ì‹¤í–‰ë˜ë„ë¡)
    searchInput.addEventListener('blur', function() {
        setTimeout(() => {
            searchResults.style.display = 'none';
        }, 200);
    });

    // ê²€ìƒ‰ì°½ í¬ì»¤ìŠ¤ ì‹œ ê¸°ì¡´ ê²€ìƒ‰ì–´ê°€ ìˆìœ¼ë©´ ê²°ê³¼ ë‹¤ì‹œ í‘œì‹œ
    searchInput.addEventListener('focus', function() {
        if (this.value.trim().length > 0) {
            this.dispatchEvent(new Event('input'));
        }
    });
}

/**
 * Helper function: HTML ì†ì„±ê°’ ì´ìŠ¤ì¼€ì´í”„
 */
function escapeAttribute(str) {
    if (!str) return '';
    return String(str).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
}

/**
 * PO ëª¨ë‹¬ì˜ ì´ í•©ê³„ë¥¼ ê³„ì‚°í•˜ì—¬ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
 */
function updatePOTotal() {
    let total = 0;
    document.querySelectorAll('#po-item-list .po-item-row').forEach(row => {
        const qty = Number(row.querySelector('.po-item-qty').value) || 0;
        const price = Number(row.querySelector('.po-item-price').value) || 0;
        total += qty * price;
    });
    const totalElement = document.getElementById('po-total-amount');
    if (totalElement) {
        totalElement.textContent = `${formatVND(total)} VND`;
    }
}

/**
 * 'ìƒˆ PO ìƒì„±' í¼ ì œì¶œì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 */
function handlePOFormSubmit(form) {
    showSpinner();
    const items = [];
    document.querySelectorAll('#po-item-list .po-item-row').forEach(row => {
        items.push({
            name: row.querySelector('.po-item-name').value,
            category: row.querySelector('.po-item-category').value,
            quantity: row.querySelector('.po-item-qty').value,
            unit: row.querySelector('.po-item-unit').value,
            unitPrice: row.querySelector('.po-item-price').value
        });
    });

    if (items.length === 0) {
        showAlert("í•˜ë‚˜ ì´ìƒì˜ ì•„ì´í…œì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.", true);
        hideSpinner();
        return;
    }

    const formData = {
        supplierId: form.supplierId.value,
        notes: form.notes.value,
        items: items
    };

    google.script.run
        .withSuccessHandler(response => {
            hideSpinner();
            closeModal();
            showAlert(response);
            loadPage("PO ê´€ë¦¬", document.querySelector('a[data-page="PO ê´€ë¦¬"]'));
        })
        .withFailureHandler(error => {
            hideSpinner();
            showAlert(error.message, true);
        })
        .addPO(formData);
}

// --- 'ë°ì´í„°ë² ì´ìŠ¤' í˜ì´ì§€ ---

/**
 * 'ì‹ ê·œ ì•„ì´í…œ ì¶”ê°€' ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.
 */
function showAddItemModal() {
    showSpinner();
    // ì•„ì´í…œ ëª¨ë‹¬ì€ ê³µê¸‰ì‚¬ ëª©ë¡ë§Œ ìˆìœ¼ë©´ ë©ë‹ˆë‹¤.
    google.script.run
        .withSuccessHandler(map => {
            hideSpinner();
            supplierMapData = map; // ê³µê¸‰ì‚¬ ë§µ ìºì‹œ
            let supplierDatalist = Object.values(map).map(name => `<option value="${name}"></option>`).join('');

            const content = `
                <form id="item-db-form">
                    <input type="hidden" name="id" value="">
                    <div class="form-group">
                        <label for="item-name">ì•„ì´í…œëª…</label>
                        <input type="text" id="item-name" name="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="item-category">ì¹´í…Œê³ ë¦¬</label>
                        <input type="text" id="item-category" name="category" class="form-control" placeholder="ì˜ˆ: ì‚¬ë¬´ìš©í’ˆ">
                    </div>
                    <div class="form-group">
                        <label for="item-notes">ë©”ëª¨ (ì„ íƒ)</label>
                        <textarea id="item-notes" name="notes" class="form-control" rows="2"></textarea>
                    </div>
                    
                    <hr class="mb-2">
                    <h5>ê³µê¸‰ì‚¬ ë° ë‹¨ê°€ ì •ë³´</h5>
                    <div id="item-supplier-list">
                        <!-- ë™ì  ê³µê¸‰ì‚¬ í–‰ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm add-item-supplier-row mt-1">
                        + ê³µê¸‰ì‚¬ ì¶”ê°€
                    </button>
                    <datalist id="supplier-list-datalist">
                        ${supplierDatalist}
                    </datalist>

                    <footer class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                        <button type="submit" class="btn btn-primary">ì €ì¥</button>
                    </footer>
                </form>
            `;
            showModal("ì‹ ê·œ ì•„ì´í…œ ì¶”ê°€", content);
        })
        .withFailureHandler(error => {
            hideSpinner();
            showAlert(error.message, true);
        })
        .getSupplierMap();
}

/**
 * 'ì•„ì´í…œ ìˆ˜ì •' ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.
 */
function showEditItemModal(id) {
    showSpinner();
    // 1. ì•„ì´í…œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    google.script.run
        .withSuccessHandler(item => {
            // 2. ê³µê¸‰ì‚¬ ë§µ ê°€ì ¸ì˜¤ê¸°
            google.script.run
                .withSuccessHandler(map => {
                    hideSpinner();
                    supplierMapData = map;
                    let supplierDatalist = Object.values(map).map(name => `<option value="${name}"></option>`).join('');
                    
                    let supplierRows = '';
                    try {
                        const suppliers = JSON.parse(item.suppliersJSON || '[]');
                        suppliers.forEach(s => {
                            supplierRows += `
                                <div class="item-supplier-row dynamic-row">
                                    <input type="text" name="supplierName" class="form-control" list="supplier-list-datalist" placeholder="ê³µê¸‰ì‚¬ëª…" value="${s.name || ''}" required>
                                    <input type="text" name="supplierUnit" class="form-control" placeholder="ë‹¨ìœ„" value="${s.unit || ''}" required>
                                    <input type="number" name="supplierPrice" class="form-control" placeholder="ë‹¨ê°€ (VND)" value="${s.price || 0}" min="0" required>
                                    <button type="button" class="btn-icon remove-row-btn">&times;</button>
                                </div>
                            `;
                        });
                    } catch (e) { console.error("ê³µê¸‰ì‚¬ JSON íŒŒì‹± ì˜¤ë¥˜:", e); }

                    const content = `
                        <form id="item-db-form">
                            <input type="hidden" name="id" value="${item.id}">
                            <div class="form-group">
                                <label for="item-name">ì•„ì´í…œëª…</label>
                                <input type="text" id="item-name" name="name" class="form-control" value="${item.name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label for="item-category">ì¹´í…Œê³ ë¦¬</label>
                                <input type="text" id="item-category" name="category" class="form-control" value="${item.category || ''}">
                            </div>
                            <div class="form-group">
                                <label for="item-notes">ë©”ëª¨ (ì„ íƒ)</label>
                                <textarea id="item-notes" name="notes" class="form-control" rows="2">${item.notes || ''}</textarea>
                            </div>
                            
                            <hr class="mb-2">
                            <h5>ê³µê¸‰ì‚¬ ë° ë‹¨ê°€ ì •ë³´</h5>
                            <div id="item-supplier-list">
                                ${supplierRows}
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm add-item-supplier-row mt-1">
                                + ê³µê¸‰ì‚¬ ì¶”ê°€
                            </button>
                            <datalist id="supplier-list-datalist">
                                ${supplierDatalist}
                            </datalist>

                            <footer class="modal-footer">
                                <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                                <button type="submit" class="btn btn-primary">ìˆ˜ì •</button>
                            </footer>
                        </form>
                    `;
                    showModal("ì•„ì´í…œ ì •ë³´ ìˆ˜ì •", content);
                })
                .withFailureHandler(err => { hideSpinner(); showAlert(err.message, true); })
                .getSupplierMap();
        })
        .withFailureHandler(error => {
            hideSpinner();
            showAlert(error.message, true);
        })
        .getItemDetails(id);
}

/**
 * ì•„ì´í…œ ëª¨ë‹¬ì— ê³µê¸‰ì‚¬ ì…ë ¥ í–‰ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
 */
function addItemSupplierRow() {
    const list = document.getElementById('item-supplier-list');
    const row = document.createElement('div');
    row.className = 'item-supplier-row dynamic-row';
    row.innerHTML = `
        <input type="text" name="supplierName" class="form-control" list="supplier-list-datalist" placeholder="ê³µê¸‰ì‚¬ëª…" required>
        <input type="text" name="supplierUnit" class="form-control" placeholder="ë‹¨ìœ„ (ì˜ˆ: ê°œ)" required>
        <input type="number" name="supplierPrice" class="form-control" placeholder="ë‹¨ê°€ (VND)" min="0" value="0" required>
        <button type="button" class="btn-icon remove-row-btn">&times;</button>
    `;
    list.appendChild(row);
}

/**
 * [ìˆ˜ì •ë¨] 'ì‹ ê·œ ì•„ì´í…œ ì¶”ê°€' ë˜ëŠ” 'ìˆ˜ì •' í¼ ì œì¶œì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 * (ì¹˜ëª…ì ì¸ ëŸ°íƒ€ì„ ì˜¤ë¥˜ ìˆ˜ì •)
 */
function handleItemDBFormSubmit(form) {
    showSpinner();
    const suppliers = [];
    document.querySelectorAll('#item-supplier-list .item-supplier-row').forEach(row => {
        suppliers.push({
            name: row.querySelector('input[name="supplierName"]').value,
            unit: row.querySelector('input[name="supplierUnit"]').value,
            price: row.querySelector('input[name="supplierPrice"]').value
        });
    });

    const formData = {
        id: form.id.value,
        itemName: form.name.value,
        category: form.category.value,
        notes: form.notes.value,
        suppliersJSON: JSON.stringify(suppliers) // JSON ë¬¸ìì—´ë¡œ ë³€í™˜
    };

    const isUpdate = formData.id ? true : false;

    // ì„±ê³µ/ì‹¤íŒ¨ ì½œë°±ì„ ì •ì˜í•©ë‹ˆë‹¤.
    const successCallback = (response) => {
        hideSpinner();
        closeModal();
        showAlert(response);
        loadPage("ë°ì´í„°ë² ì´ìŠ¤", document.querySelector('a[data-page="ë°ì´í„°ë² ì´ìŠ¤"]'));
    };

    const failureCallback = (error) => {
        hideSpinner();
        showAlert(error.message, true);
    };
    
    // isUpdate ê°’ì— ë”°ë¼ ì˜¬ë°”ë¥¸ ì„œë²„ í•¨ìˆ˜ë¥¼ ëª…ì‹œì ìœ¼ë¡œ í˜¸ì¶œí•©ë‹ˆë‹¤.
    if (isUpdate) {
        google.script.run
            .withSuccessHandler(successCallback)
            .withFailureHandler(failureCallback)
            .updateItem(formData);
    } else {
        google.script.run
            .withSuccessHandler(successCallback)
            .withFailureHandler(failureCallback)
            .addItem(formData);
    }
}


// --- 'ë¶„ì„' í˜ì´ì§€ ---

function handleTabClick(tabElement) {
    const tabs = document.querySelectorAll(".tab-link");
    const contents = document.querySelectorAll(".tab-content");

    tabs.forEach(t => t.classList.remove("active"));
    contents.forEach(c => c.classList.remove("active"));

    tabElement.classList.add("active");
    document.getElementById(tabElement.dataset.tab).classList.add("active");
}

function handleAnalysisQuery(type) {
    const startDate = document.getElementById(`${type === 'category' ? 'cat' : 'sup'}-start`).value;
    const endDate = document.getElementById(`${type === 'category' ? 'cat' : 'sup'}-end`).value;

    if (!startDate || !endDate) {
        showAlert("ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.", true);
        return;
    }

    const resultsDiv = document.getElementById(`analysis-results-${type}`);
    resultsDiv.innerHTML = '<div class="spinner-small"></div>';
    showSpinner();

    const options = {
        type: type,
        startDate: startDate,
        endDate: endDate
    };

    google.script.run
        .withSuccessHandler(result => {
            hideSpinner();
            resultsDiv.innerHTML = `
                <h5 style="margin-top:0;">${result.title}</h5>
                <table class="styled-table" style="width: 100%;">${result.htmlTable}</table>
            `;
        })
        .withFailureHandler(error => {
            hideSpinner();
            resultsDiv.innerHTML = `<p class="text-danger">${error.message}</p>`;
        })
        .getAnalysisData(options);
}

// --- íŒŒì¼ ì—…ë¡œë“œ (ê±°ë˜ëª…ì„¸ì„œ / ì„¸ê¸ˆê³„ì‚°ì„œ) ---

/**
 * íŒŒì¼ ì—…ë¡œë“œ í¼ ì œì¶œì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 * @param {HTMLFormElement} form - ì œì¶œëœ í¼
 * @param {'STATEMENT' | 'TAX'} type - ì—…ë¡œë“œ ìœ í˜•
 */
function handleFileUpload(form, type) {
    const fileInput = form.file;
    const file = fileInput.files[0];
    const submitButton = form.querySelector('button[type="submit"]');

    if (!file) {
        showAlert("ì—…ë¡œë“œí•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.", true);
        return;
    }

    // íŒŒì¼ íƒ€ì… ê²€ì¦
    if (!FILE_UPLOAD_CONFIG.ALLOWED_TYPES.includes(file.type)) {
        showAlert("ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. PDF, ì´ë¯¸ì§€, ë¬¸ì„œ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.", true);
        return;
    }

    // íŒŒì¼ í¬ê¸° ê²€ì¦
    if (file.size > FILE_UPLOAD_CONFIG.MAX_SIZE_BYTES) {
        showAlert(`íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ìµœëŒ€ ${FILE_UPLOAD_CONFIG.MAX_SIZE_MB}MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.`, true);
        return;
    }

    // 1. íŒŒì¼ì„ Base64ë¡œ ì½ê¸°
    const reader = new FileReader();
    reader.onload = function(e) {
        const fileData = e.target.result; // Base64 data
        const fileName = file.name;
        
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-small" style="width: 1.2rem; height: 1.2rem; border-width: 2px; margin: 0;"></span> ì—…ë¡œë“œ ì¤‘...';
        showSpinner(); // ì „ì²´ ìŠ¤í”¼ë„ˆë„ í‘œì‹œ

        // 2. Driveì— íŒŒì¼ ì €ì¥
        google.script.run
            .withSuccessHandler(fileUrl => {
                // 3. íŒŒì¼ URLê³¼ ë©”íƒ€ë°ì´í„°ë¥¼ ì‹œíŠ¸ì— ì €ì¥
                let recordData;
                let serverFunction;
                let pageToReload;

                if (type === 'STATEMENT') {
                    recordData = {
                        issueDate: form.issueDate.value,
                        supplierId: form.supplierId.value,
                        amount: form.amount.value,
                        poIds: form.poIds.value,
                        fileUrl: fileUrl
                    };
                    serverFunction = 'addStatementRecord';
                    pageToReload = "ê±°ë˜ëª…ì„¸ì„œ ê´€ë¦¬";
                } else { // TAX
                    recordData = {
                        issueDate: form.issueDate.value,
                        month: form.month.value,
                        supplierId: form.supplierId.value,
                        totalAmount: form.totalAmount.value,
                        fileUrl: fileUrl
                    };
                    serverFunction = 'addTaxInvoiceRecord';
                    pageToReload = "ì„¸ê¸ˆê³„ì‚°ì„œ ê´€ë¦¬";
                }

                google.script.run
                    .withSuccessHandler(response => {
                        hideSpinner();
                        showAlert(response);
                        loadPage(pageToReload, document.querySelector(`a[data-page="${pageToReload}"]`));
                    })
                    .withFailureHandler(error => {
                        hideSpinner();
                        showAlert(`íŒŒì¼ì€ Driveì— ì €ì¥ë˜ì—ˆìœ¼ë‚˜ ì‹œíŠ¸ ê¸°ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, true);
                        submitButton.disabled = false;
                        submitButton.textContent = "ì—…ë¡œë“œ ë° ì €ì¥";
                    })
                    [serverFunction](recordData);
            })
            .withFailureHandler(error => {
                hideSpinner();
                showAlert(`íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, true);
                submitButton.disabled = false;
                submitButton.textContent = "ì—…ë¡œë“œ ë° ì €ì¥";
            })
            .saveFileToDrive(fileData, fileName);
    };
    reader.onerror = function() {
        showAlert("íŒŒì¼ì„ ì½ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", true);
    };
    reader.readAsDataURL(file);
}

</script>